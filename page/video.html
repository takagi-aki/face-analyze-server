<video id="video" width="640" height="480" autoplay></video>
<canvas id="canvas" width="640" height="480" style="background-color:black;"> </canvas>
<div id="ret_view"></div>
<script>
  var video = document.getElementById('video');
  var canvas = document.getElementById('canvas');
  var context = canvas.getContext('2d');
  var ret_view = document.getElementById('ret_view');
  if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
    navigator.mediaDevices.getUserMedia({ video: true }).then(function (stream) {
      video.srcObject = stream;
      video.play();
    });
  }

  hoge = async() => {
    context.drawImage(video, 0, 0, 640, 480);
    var dataURI = canvas.toDataURL();
    var dataBase64 = dataURI.split( "," )[1];
    var body = JSON.stringify({ data: dataBase64 });
    var res = await fetch('./face/emotion', { 
      method: 'PUT', 
      headers: {
        'Content-Type': 'application/json',},
      body: body
    });
    var res = await res.blob();
    var res = await res.text();
    var analyzed_info = JSON.parse(res);
    if(analyzed_info.succeded){
      ret_view.textContent = JSON.stringify(analyzed_info.data)
    }
    setTimeout(hoge, 10)
  }

  hoge()

</script>